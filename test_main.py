import os
import sys
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
# from core.base import Module


import algorithm 
import pytest
# ! 多负荷水平自动测试代码

input_data = {
        "setting": {
            "ele_TOU_price": [
                0.2012,
                0.2012,
                0.2012,
                0.2012,
                0.2012,
                0.2012,
                0.5253,
                0.5253,
                0.5253,
                0.5253, 
                0.5253, 
                0.2012,
                0.2012,
                0.2012,
                0.5253,
                0.5253,
                0.8494,
                0.8494,
                0.8494,
                0.8494,
                0.8494,
                0.8494,
                0.8494,
                0.5253,
            ],
            "hydrogen_price": 17.92,
            "demand_electricity_price": 35.2,
        },
        "input": [
            {
                "key": "powerLoadPrediction24h",
                "type": "timeseries",
                "time": [
                    1717171200000,
                    1717171203600,
                    1717171207200,
                    1717171210800,
                    1717171214400,
                    1717171218000,
                    1717171221600,
                    1717171225200,
                    1717171228800,
                    1717171232400,
                    1717171236000,
                    1717171239600,
                    1717171243200,
                    1717171246800,
                    1717171250400,
                    1717171254000,
                    1717171257600,
                    1717171261200,
                    1717171264800,
                    1717171268400,
                    1717171272000,
                    1717171275600,
                    1717171279200,
                    1717171282800,
                ],
                "value": [
                    43.60284744,
                    43.60284744,
                    43.60284744,
                    43.60284744,
                    43.60284744,
                    43.60284744,
                    55.33008112,
                    56.1242895,
                    55.72398048,
                    54.76855654,
                    54.50142864,
                    54.48319007,
                    54.48319007,
                    54.48319007,
                    54.48319007,
                    54.48319007,
                    54.48319007,
                    54.49026064,
                    44.49527126,
                    43.60284744,
                    43.60284744,
                    43.60284744,
                    43.60284744,
                    43.60284744,
                ],
            },
            {
                "key": "pvPrediction24h",
                "type": "timeseries",
                "time": [
                    1717171200000,
                    1717171203600,
                    1717171207200,
                    1717171210800,
                    1717171214400,
                    1717171218000,
                    1717171221600,
                    1717171225200,
                    1717171228800,
                    1717171232400,
                    1717171236000,
                    1717171239600,
                    1717171243200,
                    1717171246800,
                    1717171250400,
                    1717171254000,
                    1717171257600,
                    1717171261200,
                    1717171264800,
                    1717171268400,
                    1717171272000,
                    1717171275600,
                    1717171279200,
                    1717171282800,
                ],
                "value": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0.199,
                    0.471,
                    0.65,
                    0.709,
                    0.639,
                    0.51,
                    0.34,
                    0.181,
                    0.066,
                    0.002,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ],
            },
            {
                "key": "heatingLoadPrediction24h",
                "type": "timeseries",
                "time": [
                    1717171200000,
                    1717171203600,
                    1717171207200,
                    1717171210800,
                    1717171214400,
                    1717171218000,
                    1717171221600,
                    1717171225200,
                    1717171228800,
                    1717171232400,
                    1717171236000,
                    1717171239600,
                    1717171243200,
                    1717171246800,
                    1717171250400,
                    1717171254000,
                    1717171257600,
                    1717171261200,
                    1717171264800,
                    1717171268400,
                    1717171272000,
                    1717171275600,
                    1717171279200,
                    1717171282800,
                ],
                "value": [ 
                    1600.190187,
                    1632.032254,
                    1669.301754,
                    1714.670348,
                    1771.140296,
                    1818.853456,
                    1858.058655,
                    2626.114782,
                    2724.193045,
                    2604.960738,
                    2419.049093,
                    1991.320396,
                    1904.314025,
                    1560.730439,
                    1996.425944,
                    1455.788939,
                    1429.822657,
                    1666.799084,
                    1754.978159,
                    1626.30254,
                    1715.165616,
                    1655.723477,
                    1496.522837,
                    1520.432862,
                ],
            },
            {
                "key": "envTemperaturePrediction24h",
                "type": "timeseries",
                "time": [
                    1717171200000,
                    1717171203600,
                    1717171207200,
                    1717171210800,
                    1717171214400,
                    1717171218000,
                    1717171221600,
                    1717171225200,
                    1717171228800,
                    1717171232400,
                    1717171236000,
                    1717171239600,
                    1717171243200,
                    1717171246800,
                    1717171250400,
                    1717171254000,
                    1717171257600,
                    1717171261200,
                    1717171264800,
                    1717171268400,
                    1717171272000,
                    1717171275600,
                    1717171279200,
                    1717171282800,
                ],
                "value": [
                    0,
                    0,
                    0,
                    -1,
                    -1,
                    -1,
                    -2,
                    -3,
                    -1,
                    1,
                    4,
                    7,
                    8,
                    9,
                    11,
                    12,
                    11,
                    9,
                    7,
                    5,
                    4,
                    2,
                    1,
                    0,
                ],
            },
            {
                "key": "htTemperatureStart",
                "type": "timeseries",
                "time": [1717171200000],
                "value": [55],
            },
            {
                "key": "bessSocStart",
                "type": "timeseries",
                "time": [1717171200000],
                "value": [20],
            },
            {
                "key": "htStateRT",
                "type": "timeseries",
                "time": [1717171200000],
                "value": [0]
            },
            {
                "key": "fcStateRT",
                "type": "timeseries",
                "time": [1717171200000],
                "value": [0],
            },
            {
                "key": "ebStateRT",
                "type": "timeseries",
                "time": [1717171200000],
                "value": [0],
            },
            {
                "key": "ahpStateRT",
                "type": "timeseries",
                "time": [1717171200000],
                "value": [0],
            },
            {
                "key": "ghpStateRT",
                "type": "timeseries",
                "time": [1717171200000],
                "value": [0],
            },
            
            
            {
                "key": "GheTempOutRt",
                "type": "timeseries",
                "time": [1717171200000],
                "value": [16],
            },
            {
                "key": "supplyoutTempRt",
                "type": "timeseries",
                "time": [1717171200000],
                "value": [15],
            },
        ],
    }

    # model = Module()
    # res = model.run(input_data)
    # print(res)
    # res = main(input_data.get("input"), input_data.get("setting"))    # ! 本地测试使用
    # print(res)
    
    
@pytest.mark.parametrize(
        "alpha", # * alpha为热负荷放缩比例因子
        [
            round(point / 2724, 6) for point in list(range(2000, 3501, 100))
        ]
    )
def test_main(alpha):
    algorithm.TEST_ALF = alpha    # ! 测试使用
    algorithm.main(input_data.get("input"), input_data.get("setting"))  